<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Nau Video Stream - New Proxy</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; display: flex; justify-content: center; align-items: center; color: white; font-family: sans-serif; }
        #wrapper { width: 1920px; height: 1080px; position: relative; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #status { position: absolute; top: 20px; left: 20px; background: rgba(255,0,0,0.5); padding: 10px; border-radius: 5px; font-size: 14px; z-index: 100; display: block; }
    </style>
</head>
<body>

    <div id="status">Versuche Daten zu laden...</div>

    <div id="wrapper">
        <video id="vid" autoplay muted playsinline></video>
    </div>

    <script>
        const statusDiv = document.getElementById('status');
        const v = document.getElementById('vid');
        
        // Neuer Proxy-Dienst: AllOrigins
        const TARGET_API = 'https://api.nau.ch/feeds/dooh/test';
        const PROXY = `https://api.allorigins.win/get?url=${encodeURIComponent(TARGET_API)}`;
        
        let list = [], cur = 0;

        function updateStatus(msg, isError = false) {
            statusDiv.innerText = msg;
            statusDiv.style.background = isError ? "rgba(255,0,0,0.8)" : "rgba(0,0,0,0.5)";
            // Nach Erfolg Status nach 10 Sek ausblenden
            if (!isError && msg.includes("Spiele")) {
                setTimeout(() => { statusDiv.style.display = "none"; }, 10000);
            }
        }

        async function load() {
            try {
                updateStatus("Hole Daten über AllOrigins...");
                const response = await fetch(PROXY);
                
                if (!response.ok) throw new Error('Netzwerk-Fehler');
                
                const data = await response.json();
                // AllOrigins packt die Antwort in ein "contents" Feld als String
                const jsonData = JSON.parse(data.contents);

                list = jsonData.map(item => {
                    return item.video.urls.find(u => u.endsWith('.mp4'));
                }).filter(u => u);

                if (list.length > 0) {
                    updateStatus(list.length + " Videos gefunden. Starte...");
                    play(0);
                } else {
                    updateStatus("API leer: Keine Videos gefunden.", true);
                }
            } catch (e) {
                updateStatus("FEHLER: " + e.message + " - Wahrscheinlich blockiert der Server auch diesen Proxy.", true);
            }
        }

        function play(i) {
            if (i >= list.length) i = 0;
            cur = i;
            updateStatus("Spiele Video " + (cur + 1));
            v.src = list[cur];
            v.load();
            v.play().catch(err => {
                updateStatus("Autoplay blockiert. Bitte einmal klicken.", true);
                document.body.addEventListener('click', () => { v.play(); updateStatus("Wiedergabe läuft..."); }, {once: true});
            });
        }

        v.onended = () => play(cur + 1);
        v.onerror = () => {
            updateStatus("Video-Fehler. Überspringe...", true);
            setTimeout(() => play(cur + 1), 2000);
        };

        load();
    </script>
</body>
</html>
