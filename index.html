<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Nau Video Stream - Debug Mode</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; display: flex; justify-content: center; align-items: center; color: white; font-family: sans-serif; }
        #wrapper { width: 1920px; height: 1080px; position: relative; display: flex; justify-content: center; align-items: center; }
        video { width: 100%; height: 100%; object-fit: cover; background: #000; }
        #status { position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 5px; font-size: 14px; z-index: 100; border: 1px solid #444; }
    </style>
</head>
<body>

    <div id="status">Initialisiere...</div>

    <div id="wrapper">
        <video id="vid" autoplay muted playsinline></video>
    </div>

    <script>
        const status = document.getElementById('status');
        const v = document.getElementById('vid');
        
        // Wir probieren zwei verschiedene Proxies, falls einer hakt
        const TARGET_API = 'https://api.nau.ch/feeds/dooh/test';
        const PROXY = 'https://corsproxy.io/?' + encodeURIComponent(TARGET_API);
        
        let list = [], cur = 0;

        function log(msg) {
            status.innerText = msg;
            console.log(msg);
        }

        async function load() {
            log("Lade Daten von API...");
            try {
                const r = await fetch(PROXY);
                if (!r.ok) throw new Error("Server-Antwort nicht okay: " + r.status);
                
                const d = await r.json();
                log("Daten empfangen, verarbeite...");

                list = d.map(item => {
                    const mp4 = item.video.urls.find(u => u.endsWith('.mp4'));
                    return mp4;
                }).filter(u => u);

                log(list.length + " Videos gefunden.");

                if (list.length > 0) {
                    play(0);
                } else {
                    log("Fehler: Keine MP4-Videos in der API gefunden.");
                }
            } catch (e) {
                log("FEHLER: " + e.message);
                console.error(e);
            }
        }

        function play(i) {
            if (i >= list.length) i = 0;
            cur = i;
            
            log("Spiele Video " + (cur + 1) + " von " + list.length);
            
            v.src = list[cur];
            
            // Wichtig für manche Browser: load() vor play()
            v.load(); 
            
            const playPromise = v.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    log("Autoplay blockiert. Klicke einmal auf die Seite.");
                    // Fallback: Klick-Event, um Video zu starten
                    document.body.addEventListener('click', () => {
                        v.play();
                        log("Video gestartet nach Klick.");
                    }, {once: true});
                });
            }
        }

        v.onended = () => {
            log("Video beendet, lade nächstes...");
            play(cur + 1);
        };

        v.onerror = () => {
            log("Video-Ladefehler bei Index " + cur + ". Überspringe...");
            setTimeout(() => play(cur + 1), 2000);
        };

        load();
    </script>
</body>
</html>
